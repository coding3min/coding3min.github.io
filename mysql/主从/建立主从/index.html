<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="前提 #  本方案是两节点主从方案，只要建立好主从，及时数据库挂掉又拉起主从模式不会失效。
 保证时间同步 保证都安装了mysql/mariadb  建立主从的过程 #  这里介绍的是两节点主从，如果是集群模式，至少需要三个节点，因为偶数个节点是导致脑裂高发的原因（无法确定该同步谁的）。
 主从服务器节点设置不同的server-id 启用二进制日志和relaylog 主节点创建一个拥有复制权限的用户账号 查询主节点binlog信息 设置从节点同步主节点  停止所有写入 #  在所有服务器上执行此步
在所有服务器上执行此步
在所有服务器上执行此步
停止所有写入是为了防止数据设置同步的过程中数据不一致。
如果 mariadb 是通过 hosts 文件中的域名进行访问的，那么只需要编辑 /etc/hosts , 把mysql的域名解析删掉就可以停止所有读写，执行以下命令。
关掉所有读写mysql的服务，你也可以直接用iptables来禁用端口通信（如果应用有自动重连机制的话，否则只能重启应用了）
等待 1 分钟，依次进入集群中所有的 mariadb ，查看进程状态，确保没有额外的读写操作( command 列除了 show processlist 外没有多余的 sleep 和 query )。
MariaDB [(none)]> show processlist; 备份与导入 #  首先，你需要保证所有的节点数据一致，在升级过程中万一升级失败能及时的恢复数据。
请参考本小册 备份数据库
添加一个专门用来同步的用户 #  在从节点中的 mariadb 执行以下命令，如果全部输出 ok，则继续。
/usr/local/mariadb/bin/mysql -A -e &#34;GRANT replication slave ON *."><meta name=theme-color content="#FFFFFF"><meta property="og:title" content><meta property="og:description" content="前提 #  本方案是两节点主从方案，只要建立好主从，及时数据库挂掉又拉起主从模式不会失效。
 保证时间同步 保证都安装了mysql/mariadb  建立主从的过程 #  这里介绍的是两节点主从，如果是集群模式，至少需要三个节点，因为偶数个节点是导致脑裂高发的原因（无法确定该同步谁的）。
 主从服务器节点设置不同的server-id 启用二进制日志和relaylog 主节点创建一个拥有复制权限的用户账号 查询主节点binlog信息 设置从节点同步主节点  停止所有写入 #  在所有服务器上执行此步
在所有服务器上执行此步
在所有服务器上执行此步
停止所有写入是为了防止数据设置同步的过程中数据不一致。
如果 mariadb 是通过 hosts 文件中的域名进行访问的，那么只需要编辑 /etc/hosts , 把mysql的域名解析删掉就可以停止所有读写，执行以下命令。
关掉所有读写mysql的服务，你也可以直接用iptables来禁用端口通信（如果应用有自动重连机制的话，否则只能重启应用了）
等待 1 分钟，依次进入集群中所有的 mariadb ，查看进程状态，确保没有额外的读写操作( command 列除了 show processlist 外没有多余的 sleep 和 query )。
MariaDB [(none)]> show processlist; 备份与导入 #  首先，你需要保证所有的节点数据一致，在升级过程中万一升级失败能及时的恢复数据。
请参考本小册 备份数据库
添加一个专门用来同步的用户 #  在从节点中的 mariadb 执行以下命令，如果全部输出 ok，则继续。
/usr/local/mariadb/bin/mysql -A -e &#34;GRANT replication slave ON *."><meta property="og:type" content="article"><meta property="og:url" content="https://leetcode.coding3min.com/mysql/%E4%B8%BB%E4%BB%8E/%E5%BB%BA%E7%AB%8B%E4%B8%BB%E4%BB%8E/"><meta property="article:section" content="mysql"><title>建立主从 | 程序员的魔法书</title><link rel=manifest href=/manifest.json><link rel=icon href=/favicon.png type=image/x-icon><link rel=stylesheet href=/book.min.958cea7827621d6fbcb3acf091344c3e44e3d2a9428f9c3c38bb9eb37bf8c45d.css integrity="sha256-lYzqeCdiHW+8s6zwkTRMPkTj0qlCj5w8OLues3v4xF0=" crossorigin=anonymous><script defer src=/flexsearch.min.js></script><script defer src=/en.search.min.9743218a9b114aeb464b4ee93a2e447b8c9df2a07e1de157caa2f0c8a81fadb7.js integrity="sha256-l0MhipsRSutGS07pOi5Ee4yd8qB+HeFXyqLwyKgfrbc=" crossorigin=anonymous></script><script defer src=/sw.min.6f6f90fcb8eb1c49ec389838e6b801d0de19430b8e516902f8d75c3c8bd98739.js integrity="sha256-b2+Q/LjrHEnsOJg45rgB0N4ZQwuOUWkC+NdcPIvZhzk=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a href=/><img src=/logo.png alt=Logo><span>程序员的魔法书</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><a href=/readme/>知识库介绍</a></li><li><a href=/contribute/>如何贡献</a></li><li><a href=/todo/>待解答问题列表</a></li><li><a href=%e8%b5%84%e6%ba%90%e5%ba%93/README>资源库</a></li><li><a href=/blog/>大佬Blog</a></li><li><a href=/interview/xiang-mu-wen-shi-mo/>项目一般问什么</a></li><li><a href=/leetcode/suan-fa-mian-shi-zhu-yi/>算法面试注意</a></li><li><a href=/leetcode/shu-ju-jie-gou/>数据结构</a></li><li><a href=/leetcode/easy/>LeetCode-hot100-easy</a></li><li><a href=/leetcode/medium/>LeetCode-hot100-medium</a></li><li><a href=/leetcode/difficult/>LeetCode-hot100-difficult</a></li><li><a href=/leetcode/other/>其他高频算法</a></li><li><a href=/leetcode/hua-wei-ji-shi/>华为机试</a></li><li><a href=/interview/cao-zuo-xi-tong/>操作系统</a></li><li><a href=/interview/qian-duan/>前端</a></li><li><a href=/interview/linux/>Linux</a></li><li><a href=/interview/go/><strong>Go</strong></a><ul><li><a href=https://golang.coding3min.com>Go语言精进之路</a></li></ul></li><li><a href=/interview/java/>Java</a></li><li><a href=/interview/redis/>Redis</a></li><li><a href=/interview/mysql/>Mysql</a></li><li><a href=/interview/queue/>消息队列</a></li><li><a href=/interview/network/>网络</a></li><li><a href=/interview/mongodb/>mongoDB</a></li><li><a href=/leetcode-vscode/>协作办法</a></li><li><a href=interview/devops><strong>devops</strong></a><ul><li><a href=jenkins/jenkins%e5%bf%ab%e9%80%9f%e5%85%a5%e9%97%a8>jenkins 快速入门</a></li></ul></li><li><a href=/interview/mysql/><strong>Mysql</strong></a><ul><li><a href=mysql/%e9%9b%86%e7%be%a4>集群</a><ul><li><a href=/mysql/%E9%9B%86%E7%BE%A4/%E5%BF%AB%E9%80%9F%E6%8B%89%E8%B5%B7/>快速拉起</a></li></ul></li><li><a href=mysql/%e4%b8%bb%e4%bb%8e>主从</a><ul><li><a href=/mysql/%E4%B8%BB%E4%BB%8E/%E5%BB%BA%E7%AB%8B%E4%B8%BB%E4%BB%8E/ class=active>建立主从</a></li><li><a href=/mysql/%E4%B8%BB%E4%BB%8E/relaylog/>relaylog 详解</a></li><li><a href=/mysql/%E4%B8%BB%E4%BB%8E/%E4%B8%BB%E4%BB%8E%E5%88%87%E6%8D%A2/>主从切换</a></li><li><a href=/mysql/%E4%B8%BB%E4%BB%8E/%E9%9B%86%E7%BE%A4%E6%96%B9%E6%A1%88%E5%88%87%E6%8D%A2%E4%B8%BA%E4%BA%92%E4%B8%BA%E4%B8%BB%E4%BB%8E/>集群方案切换为互为主从</a></li><li><a href=/mysql/%E4%B8%BB%E4%BB%8E/%E5%B8%B8%E8%A7%81%E6%95%85%E9%9A%9C/>常见故障</a></li><li><a href=/mysql/%E4%B8%BB%E4%BB%8E/mysql%E7%9A%84expire_logs_days%E5%8F%82%E6%95%B0%E5%BC%95%E5%8F%91%E7%9A%84%E4%B8%BB%E4%BB%8E%E7%8A%B6%E6%80%81%E4%B8%A2%E5%A4%B1%E9%97%AE%E9%A2%98/>mysql 的 expire_logs_days 参数引发的主从状态丢失问题</a></li></ul></li><li><a href=mysql/%e8%bf%90%e7%bb%b4>运维</a><ul><li><a href=/mysql/%E8%BF%90%E7%BB%B4/%E5%BF%98%E8%AE%B0%E5%AF%86%E7%A0%81/>忘记密码</a></li><li><a href=/mysql/%E8%BF%90%E7%BB%B4/%E5%A4%87%E4%BB%BD%E6%95%B0%E6%8D%AE%E5%BA%93/>备份数据库</a></li><li><a href=/mysql/%E8%BF%90%E7%BB%B4/%E9%87%8D%E5%BB%BAmysql%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E6%96%B9%E6%B3%95/>重建 mysql 数据库的方法</a></li><li><a href=/mysql/%E8%BF%90%E7%BB%B4/mysql%E6%AD%A3%E7%A1%AE%E6%B8%85%E7%90%86binlog%E6%97%A5%E5%BF%97%E7%9A%84%E4%B8%A4%E7%A7%8D%E6%96%B9%E6%B3%95/>mysql 正确清理 binlog 日志的两种方法</a></li><li><a href=/mysql/%E8%BF%90%E7%BB%B4/%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9/>注意事项</a></li></ul></li></ul></li><li><a href=/tools/readme/>实用工具</a></li><li><a href=docker><strong>Docker</strong></a><ul><li><strong>Docker 入门</strong><ul><li><a href=Docker>容器&Docker 入门</a></li><li><a href=Docker/chapter.1/docker-story>容器故事</a></li><li><a href=Docker/chapter.1/deal-what>能解决什么问题</a></li><li><a href=Docker/chapter.1/docker-superiority>优势</a></li><li><a href=Docker/chapter.1/what-is-image>镜像概念</a></li><li><a href=Docker/chapter.1/what-is-docker>容器概念</a></li><li><a href=Docker/chapter.1/what-is-repository>仓库概念</a></li></ul></li><li><a href=Docker><strong>Docker 安装</strong></a><ul><li><a href=Docker/chapter.1/%e5%ae%89%e8%a3%85Docker>安装说明</a></li><li><a href=Docker/chapter.1/Centos%e5%ae%89%e8%a3%85>CentOS 安装</a></li><li><a href=Docker/chapter.1/Windows%e5%ae%89%e8%a3%85>Windows 安装</a></li><li><a href=Docker/chapter.1/Macbook%e5%ae%89%e8%a3%85>Macbook 安装</a></li><li><a href=Docker/chapter.1/README>容器&docker 入门实验</a></li></ul></li><li><a href=Docker/chapter.2/README><strong>Docker 命令</strong></a><ul><li><a href=Docker/chapter.2/base-command>基础命令</a></li><li><a href=Docker/chapter.2/image-command>镜像命令</a></li><li><a href=Docker/chapter.2/container-command>容器操作命令</a></li><li><a href=Docker/chapter.2/container-command2>容器管理命令</a></li><li><a href=Docker/chapter.2/resources-command>资源命令</a></li><li><a href=Docker/chapter.2/lab-wordpress>wordpress 博客系统</a></li><li><a href=Docker/chapter.2/lab-python>python 文件下载系统</a></li></ul></li><li><strong>Docker 镜像</strong><ul><li><a href=Docker/chapter.3/c-dockerfile>Dockerfile</a></li><li><a href=Docker/chapter.3/repositories>个人仓库</a></li><li><a href=Docker/chapter.4/best-dockerfile>Dockerfile 最佳实践</a></li><li><a href=Docker/chapter.4/best-dockerfile-other>Dockerfile 其他建议</a></li></ul></li><li><strong>Docker 网络-todo</strong></li><li><strong>Docker 存储-todo</strong><ul><li>数据卷-todo</li><li>挂载卷-todo</li></ul></li><li><strong>Docker Compose-todo</strong></li><li><strong>Docker Swarm-todo</strong></li></ul></li><li><a href=k8s>k8s</a><ul><li>Kubernetes 入门-todo</li><li><a href=Kubernetes/chapter.1/install-k8s>Kubernetes 安装-todo</a></li><li><a href=Kubernetes/skill/k8s%e6%8a%80%e5%b7%a7%e5%ae%8c%e5%85%a8%e7%89%88>k8s 技巧大全</a></li><li><a href=Kubernetes/CKA-1/Intorduction>CKA 刷题之路</a><ul><li><a href=Kubernetes/CKA-1/cka-list>2019 年考试题目</a></li></ul></li></ul></li></ul></nav><script>(function(){var a=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(b){localStorage.setItem("menu.scrollTop",a.scrollTop)}),a.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label>
<strong>建立主从</strong>
<label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><ul><li><a href=#前提>前提</a></li><li><a href=#建立主从的过程>建立主从的过程</a></li><li><a href=#停止所有写入>停止所有写入</a></li><li><a href=#备份与导入>备份与导入</a></li><li><a href=#添加一个专门用来同步的用户>添加一个专门用来同步的用户</a></li><li><a href=#停止所有节点>停止所有节点</a></li><li><a href=#更新-mysql-配置从节点>更新 mysql 配置（从节点）</a></li><li><a href=#启动主节点并获取主节点信息>启动主节点并获取主节点信息</a></li><li><a href=#启动从节点并设置同步信息>启动从节点并设置同步信息</a></li><li><a href=#可能遇到的坑>可能遇到的坑</a></li><li><a href=#如果你想建立互为主从>如果你想建立互为主从</a></li></ul></li></ul></nav></aside></header><article class=markdown><h3 id=前提>前提
<a class=anchor href=#%e5%89%8d%e6%8f%90>#</a></h3><p>本方案是两节点主从方案，只要建立好主从，及时数据库挂掉又拉起主从模式不会失效。</p><ul><li>保证时间同步</li><li>保证都安装了<code>mysql/mariadb</code></li></ul><h3 id=建立主从的过程>建立主从的过程
<a class=anchor href=#%e5%bb%ba%e7%ab%8b%e4%b8%bb%e4%bb%8e%e7%9a%84%e8%bf%87%e7%a8%8b>#</a></h3><p>这里介绍的是两节点主从，如果是集群模式，至少需要三个节点，因为偶数个节点是导致脑裂高发的原因（无法确定该同步谁的）。</p><ol><li>主从服务器节点设置不同的<code>server-id</code></li><li>启用二进制日志和<code>relaylog</code></li><li>主节点创建一个拥有复制权限的用户账号</li><li>查询主节点<code>binlog</code>信息</li><li>设置从节点同步主节点</li></ol><h3 id=停止所有写入>停止所有写入
<a class=anchor href=#%e5%81%9c%e6%ad%a2%e6%89%80%e6%9c%89%e5%86%99%e5%85%a5>#</a></h3><p><strong>在所有服务器上执行此步</strong></p><p><strong>在所有服务器上执行此步</strong></p><p><strong>在所有服务器上执行此步</strong></p><p>停止所有写入是为了防止数据设置同步的过程中数据不一致。</p><p>如果 <code>mariadb</code> 是通过 <code>hosts</code> 文件中的域名进行访问的，那么只需要编辑 <code>/etc/hosts</code> , 把<code>mysql</code>的域名解析删掉就可以停止所有读写，执行以下命令。</p><p>关掉所有读写<code>mysql</code>的服务，你也可以直接用<code>iptables</code>来禁用端口通信（如果应用有自动重连机制的话，否则只能重启应用了）</p><p>等待 1 分钟，依次进入集群中所有的 <code>mariadb</code> ，查看进程状态，确保没有额外的读写操作( <code>command</code> 列除了 <code>show processlist</code> 外没有多余的 <code>sleep</code> 和 <code>query</code> )。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql>MariaDB [(<span style=color:#66d9ef>none</span>)]<span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>show</span> processlist;
</code></pre></div><h3 id=备份与导入>备份与导入
<a class=anchor href=#%e5%a4%87%e4%bb%bd%e4%b8%8e%e5%af%bc%e5%85%a5>#</a></h3><p>首先，你需要保证所有的节点数据一致，在升级过程中万一升级失败能及时的恢复数据。</p><p>请参考本小册
<a href=https://www.kancloud.cn/coding3min/playdb/1760472>备份数据库</a></p><h3 id=添加一个专门用来同步的用户>添加一个专门用来同步的用户
<a class=anchor href=#%e6%b7%bb%e5%8a%a0%e4%b8%80%e4%b8%aa%e4%b8%93%e9%97%a8%e7%94%a8%e6%9d%a5%e5%90%8c%e6%ad%a5%e7%9a%84%e7%94%a8%e6%88%b7>#</a></h3><p>在从节点中的 <code>mariadb</code> 执行以下命令，如果全部输出 ok，则继续。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-BASH data-lang=BASH>/usr/local/mariadb/bin/mysql -A -e <span style=color:#e6db74>&#34;GRANT replication slave ON *.* TO &#39;rep&#39;@&#39;%&#39; IDENTIFIED BY &#39;123456&#39;; flush privileges;&#34;</span>
mysql -A -urep -p123456 -e <span style=color:#e6db74>&#34;select &#39;ok&#39;;&#34;</span>
</code></pre></div><h3 id=停止所有节点>停止所有节点
<a class=anchor href=#%e5%81%9c%e6%ad%a2%e6%89%80%e6%9c%89%e8%8a%82%e7%82%b9>#</a></h3><p>执行以下命令停止</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-BASH data-lang=BASH>/usr/local/mariadb/bin/mysqladmin  shutdown
</code></pre></div><p>此时节点应该自动停止了，检查是否没有 <code>mariadb</code> 和 <code>mysql</code> 进程，如果有按需求判断是否停掉(<code>kill</code>)。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-BASH data-lang=BASH>ps -ef | grep -E <span style=color:#e6db74>&#34;mariadb|mysql&#34;</span>
</code></pre></div><h3 id=更新-mysql-配置从节点>更新 mysql 配置（从节点）
<a class=anchor href=#%e6%9b%b4%e6%96%b0-mysql-%e9%85%8d%e7%bd%ae%e4%bb%8e%e8%8a%82%e7%82%b9>#</a></h3><p>先创建<code>relaylog</code>日志存储的目录，用来防止同步波动缓存同步信息。（注意，请设置成你自己的数据目录）</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-BASH data-lang=BASH>mkdir /data/mariadb/relaylog
chown -R mysql.mysql /data/mariadb/relaylog/
</code></pre></div><p>添加配置到 <code>[mysqld]</code> 配置节中（<strong>注意现在不启动</strong>），该配置表示我们只同步 <code>cloud</code> 库和其下的表，如果要同步更多的库和表可以用逗号分隔，追加。</p><p>如果想了解各个参数是什么含义可以到本小册
<a href=https://www.kancloud.cn/coding3min/playdb/1760394>relaylog</a>里看</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-BASH data-lang=BASH>vim /etc/my.cnf.d/server.cnf
<span style=color:#75715e># 添加内容如下</span>
replicate-do-db<span style=color:#f92672>=</span>cloud <span style=color:#75715e>#cloud是你想同步的库名，如果有多个请用逗号隔开</span>
log-slave-updates
replicate-wild-do-table<span style=color:#f92672>=</span>cloud.% <span style=color:#75715e>#cloud是你想同步的库名，cloud.% 代表这个库下面的所有表，如果有多个请用逗号隔开</span>
binlog-ignore-db<span style=color:#f92672>=</span>mysql <span style=color:#75715e># 忽略mysql库</span>
max_relay_log_size <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
relay_log<span style=color:#f92672>=</span>/data/mariadb/relaylog/relay-bin <span style=color:#75715e>#请设置成正确的目录，上面刚刚创建的那个，最后的relay-bin是文件前缀</span>
relay_log_purge <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
relay_log_recovery <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
sync_relay_log <span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
sync_relay_log_info <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
slave-skip-errors<span style=color:#f92672>=</span>1032,1062,1053,1146,2003
</code></pre></div><p>参考添加成功的图片</p><p><img src=https://coding3min.oss-accelerate.aliyuncs.com/2020/06/10/hKADxe1630.png alt></p><h3 id=启动主节点并获取主节点信息>启动主节点并获取主节点信息
<a class=anchor href=#%e5%90%af%e5%8a%a8%e4%b8%bb%e8%8a%82%e7%82%b9%e5%b9%b6%e8%8e%b7%e5%8f%96%e4%b8%bb%e8%8a%82%e7%82%b9%e4%bf%a1%e6%81%af>#</a></h3><p>如果你的目录不同请自行修改</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-BASH data-lang=BASH>mkdir -p /var/run/mariadb; chown -R mysql:mysql /var/run/mariadb; /usr/local/mariadb/bin/mysqld_safe --datadir<span style=color:#f92672>=</span>/data/mariadb/data --pid-file<span style=color:#f92672>=</span>/var/run/mariadb/mariadb.pid  &gt; /dev/null 2&gt;&amp;<span style=color:#ae81ff>1</span>  &amp;
</code></pre></div><p><strong>获取同步主节点的关键信息</strong></p><p>进入主节点数据库中，执行命令</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql>unlock tables;
<span style=color:#66d9ef>show</span> master status;
</code></pre></div><p>得到同步主节点的关键信息</p><p><img src=https://coding3min.oss-accelerate.aliyuncs.com/2020/06/04/yilSlx1718.png alt></p><h3 id=启动从节点并设置同步信息>启动从节点并设置同步信息
<a class=anchor href=#%e5%90%af%e5%8a%a8%e4%bb%8e%e8%8a%82%e7%82%b9%e5%b9%b6%e8%ae%be%e7%bd%ae%e5%90%8c%e6%ad%a5%e4%bf%a1%e6%81%af>#</a></h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-BASH data-lang=BASH>mkdir -p /var/run/mariadb; chown -R mysql:mysql /var/run/mariadb; /usr/local/mariadb/bin/mysqld_safe --datadir<span style=color:#f92672>=</span>/data/mariadb/data --pid-file<span style=color:#f92672>=</span>/var/run/mariadb/mariadb.pid  &gt; /dev/null 2&gt;&amp;<span style=color:#ae81ff>1</span>  &amp;
</code></pre></div><p><strong>建立主从结构</strong></p><p>进入从节点的数据库，指定主库信息，完成主从关系建立（注意：下面命令中的【主节点 ip 地址】别忘记替换，使用 <code>eth0</code> 本地网卡的 <code>ip</code> ，不要使用浮动 <code>ip</code> ，也不要使用 <code>vip</code> ）</p><p>账号和密码就是我们刚刚设置的，</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql>unlock tables;
CHANGE MASTER <span style=color:#66d9ef>TO</span>
MASTER_HOST<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;主节点的ip地址&#39;</span>,
MASTER_PORT<span style=color:#f92672>=</span><span style=color:#ae81ff>3306</span>,
MASTER_USER<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;rep&#39;</span>,
MASTER_PASSWORD<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;123456&#39;</span>,
MASTER_LOG_FILE<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;mysql-bin.000171&#39;</span>,
MASTER_LOG_POS<span style=color:#f92672>=</span><span style=color:#ae81ff>33105258</span>;
<span style=color:#66d9ef>start</span> slave; <span style=color:#f92672>#</span><span style=color:#960050;background-color:#1e0010>开始同步</span>
</code></pre></div><p>查看 slave 的状态，注意查看 slave 的进程状态，下面红色方框中圈起来的是两个 <code>Yes</code> 就表示状态正常了，注意等待主库复制的延迟秒数变为 0 <code>Seconds_Behind_Master: 0</code></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>show</span> slave status <span style=color:#960050;background-color:#1e0010>\</span><span style=color:#66d9ef>G</span>
</code></pre></div><p><img src=https://coding3min.oss-accelerate.aliyuncs.com/2020/06/04/K12msW1736.png alt></p><p>the end</p><h3 id=可能遇到的坑>可能遇到的坑
<a class=anchor href=#%e5%8f%af%e8%83%bd%e9%81%87%e5%88%b0%e7%9a%84%e5%9d%91>#</a></h3><p>请根据你的业务写入速度和同步速度，设置好主节点的<code>binlog</code>大小和过期时间，具体设置方法请参考本小册
<a href=https://www.kancloud.cn/coding3min/playdb/1760397>mysql 正确清理 binlog 日志的两种方法</a>中的<em>方法二、通过设置 binlog 过期的时间，使系统自动删除 binlog 文件</em>。</p><h3 id=如果你想建立互为主从>如果你想建立互为主从
<a class=anchor href=#%e5%a6%82%e6%9e%9c%e4%bd%a0%e6%83%b3%e5%bb%ba%e7%ab%8b%e4%ba%92%e4%b8%ba%e4%b8%bb%e4%bb%8e>#</a></h3><p>如果你想建立互为主从，那么你可以把主节点当作从节点，把从节点当作主节点，从本文的</p><p><a href=/#%e6%b7%bb%e5%8a%a0%e4%b8%80%e4%b8%aa%e4%b8%93%e9%97%a8%e7%94%a8%e6%9d%a5%e5%90%8c%e6%ad%a5%e7%9a%84%e7%94%a8%e6%88%b7>添加一个专门用来同步的用户</a>开始重新执行，直到最后一步。</p></article><div class="book-footer justify-between"></div><hr style=height:1px;background:var(--gray-200)><br><p>本图书由<a href=https://github.com/minibear2333>小熊</a>©2021 版权所有，<a href=https://golang.coding3min.com/>所有文章</a>采用<a href=https://creativecommons.org/licenses/by-nc-nd/4.0/deed.zh>知识署名-非商业性使用-禁止演绎 4.0 国际</a>进行许可。</p><div style=text-align:center><p><img width=70% style=width:70%;height:70%;!important src=https://coding3min.oss-accelerate.aliyuncs.com/2021/06/24/qrcode.png></p></div><script src=https://utteranc.es/client.js repo=coding3min/comment issue-term=title theme=github-light crossorigin=anonymous async></script><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/coding3min/interview-leetcode/edit/master/./mysql/%e4%b8%bb%e4%bb%8e/%e5%bb%ba%e7%ab%8b%e4%b8%bb%e4%bb%8e.md target=_blank rel=noopener><img src=/svg/edit.svg class=book-icon alt=Edit>
<span>Edit this page</span></a></div></div><script>(function(){function a(c){const a=window.getSelection(),b=document.createRange();b.selectNodeContents(c),a.removeAllRanges(),a.addRange(b)}document.querySelectorAll("pre code").forEach(b=>{b.addEventListener("click",function(c){a(b.parentElement),navigator.clipboard&&navigator.clipboard.writeText(b.parentElement.textContent)})})})()</script></footer><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><ul><li><a href=#前提>前提</a></li><li><a href=#建立主从的过程>建立主从的过程</a></li><li><a href=#停止所有写入>停止所有写入</a></li><li><a href=#备份与导入>备份与导入</a></li><li><a href=#添加一个专门用来同步的用户>添加一个专门用来同步的用户</a></li><li><a href=#停止所有节点>停止所有节点</a></li><li><a href=#更新-mysql-配置从节点>更新 mysql 配置（从节点）</a></li><li><a href=#启动主节点并获取主节点信息>启动主节点并获取主节点信息</a></li><li><a href=#启动从节点并设置同步信息>启动从节点并设置同步信息</a></li><li><a href=#可能遇到的坑>可能遇到的坑</a></li><li><a href=#如果你想建立互为主从>如果你想建立互为主从</a></li></ul></li></ul></nav></div></aside></main></body></html>